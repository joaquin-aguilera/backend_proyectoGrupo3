version: '3.8'

services:
  # --- FRONTEND BÚSQUEDA ---
  frontend_busqueda:
    build: ./frontend
    container_name: frontend_busqueda
    ports:
      - "5620:80"
    networks:
      - appnet
    depends_on:
      - backend_busqueda

  # --- BACKEND BÚSQUEDA ---
  backend_busqueda:
    build: ./backend
    container_name: backend_busqueda
    environment:
      - NODE_ENV=production
      - PORT=5610
      - MONGODB_URI=mongodb://search_user:search_pass@db_mongodb:27017/searchdb?authSource=searchdb
      - MONGO_ROOT_USER=root
      - MONGO_ROOT_PASSWORD=rootpass
      - FRONTEND_ORIGIN=http://localhost:5620
      - PRODUCTS_API_URL=http://localhost:4040/api
    ports:
      - "5610:5610"
    networks:
      - appnet
    depends_on:
      - db_mongodb

  # --- BASE DE DATOS MONGODB ---
  db_mongodb:
    image: mongo:7.0
    container_name: db_mongodb_busqueda
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpass
      MONGO_INITDB_DATABASE: searchdb
    volumes:
      - mongodb_data:/data/db
      - ./backend/src/BD/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5173:27017"
    networks:
      - appnet

  # --- MONGO EXPRESS (OPCIONAL - INTERFAZ BD) ---
  mongo_express:
    image: mongo-express:latest
    container_name: mongo_express_busqueda
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: rootpass
      ME_CONFIG_MONGODB_SERVER: db_mongodb
      ME_CONFIG_BASICAUTH: "false"
    ports:
      - "8081:8081"
    networks:
      - appnet
    depends_on:
      - db_mongodb

  # --- NGINX REVERSE PROXY (OPCIONAL) ---
  # Descomenta si quieres usar nginx como proxy inverso
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx_proxy
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
  #   depends_on:
  #     - frontend_busqueda
  #     - backend_busqueda
  #   networks:
  #     - appnet

networks:
  appnet:
    driver: bridge

volumes:
  mongodb_data:
